<!DOCTYPE html>
<html>

	<head>
		<meta charset="UTF-8"> 
		<link rel="stylesheet" type="text/css" href="/assets/styles/styles.css">
		
		<link rel="stylesheet" type="text/css" href="/assets/styles/highlight.css">
		
		<title>Datetime in Python - foobuzz</title>
	</head>
	
	<body>
	<div id="main_wrapper">
	
		<header>
			<h1><a href="/">foobuzz</a></h1>
		</header>
		
		<nav>
			<ul id="navigation">
				<li><a href="/">Front</a></li>
			    <li><a href="/archives">Archives</a></li>
			    <li><a href="/about">About</a></li>
			</ul>

			
		 	<ul id="networking">
				
					<li><a href="https://twitter.com/_foobuzz"><img src="/assets/icons/twitbird.png" alt="The Twitter icon"></a></li>
				
				
					<li><a href="https://github.com/foobuzz"><img src="/assets/icons/github.png" alt="The GitHub icon"></a></li>
				
					<li><a href="/feed.xml"><img src="/assets/icons/atom.png" alt="The RSS/Atom icon"></a></li>
			</ul>
			
		</nav>
		
		<div id="main">
		
			<div id="content">

				

<article>

	<div class="entete">by Valentin, November 25 2015, in
		
		<a href="/tag/programming">programming</a>, 
		
		<a href="/tag/python">python</a>
		
	</div>

	<h1><a href="/datetime-python">Datetime in Python</a></h1>

	

<p>Last Friday I spent two hours fighting with the datetime class from Python's datetime module. I originally thought that a datetime object represented a single point in time, which is not always the case. I sum up with a few bullets points what I learned about this module:</p>
<ul>
<li>
<p>In its simplest form, a datetime object is just a date and a time as you would write it down on a piece of paper. It's a year, a month, a day, and, optionally, an hour, a minute, a second and some microseconds (the 'time' part of 'datetime').</p>
</li>
<li>
<p>So, in this simplest form, a datetime object does not represent a given point in time because it depends on the timezone in which you consider your date and time. It's up to interpretation. Such datetime objects are called <em>naive</em>. You can make a datetime object <em>aware</em> by giving to it the timezone that should be used to interpret this date and time. An <em>aware</em> datetime object does represent a given point in time.</p>
</li>
<li>
<p>The optionnal timezone carried by a datetime object is given by the <code>tzinfo</code> attribute, whose value is of type <code>tzinfo</code>. The tzinfo class is an abstract base class, meaning you can't directly instanciate a tzinfo object. You must instanciate a subclass of tzinfo, such as <code>timezone</code>. But to construct a timezone object, you must give it a <code>timedelta</code> object. The timedelta class represents a difference between two datetimes. When used to construct a timezone, it indicates the offset in relation to UTC. For example, <code>timezone(timedelta(hours=2))</code> is a valid tzinfo object which represents the timezone UTC+2. <code>timezone.utc</code> is a shortcut for <code>timezone(timedelta(0))</code>.</p>
</li>
<li>
<p>Most methods which return a datetime object return a <em>naive</em> object. The method <code>now</code> returns the local and naive date and time; the method <code>utcnow</code> returns the UTC naive date and time. Since Python 3.2, the <code>strptime</code> method can produce an aware datetime object from a string. The string must contain the timezone in the <code>+HHMM</code> or <code>-HHMM</code> format (for example <code>+0200</code> for UTC+2), and the placeholder to use is <code>%z</code> to capture the timezone part.</p>
</li>
</ul>
<h2>Practical example</h2>
<p>Let's say you've acquired such a string representating a date and a time: <code>Mon Nov 23 20:06:13 CET 2015</code>. It's actually the default output's format of the <code>date</code> command in bash. Let's say you want to write a Python script that tells you the exact time difference between the moment the script is executed and the date and time represented by this string.</p>
<p>We're in bad luck here because Python won't be able to tell us to what timezone <code>CET</code> corresponds to. Remember, it can only parse timezones if they're in the form <code>+HHMM</code>. So we need to do some basic research. It turns out that CET stands for Central European Time and is UTC+1.</p>
<p>Now that we have such knowledge, a solution is to replace <code>CET</code> by <code>+0100</code> in the string then let Python produces an aware datetime object.</p>
<div class="codehilite"><pre class="source"><code><span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span><span class="p">,</span> <span class="n">timezone</span>

<span class="n">DATETIME_STRING</span> <span class="o">=</span> <span class="s">'Mon Nov 23 20:06:13 CET 2015'</span>
<span class="n">string</span> <span class="o">=</span> <span class="n">DATETIME_STRING</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">'CET'</span><span class="p">,</span> <span class="s">'+0100'</span><span class="p">)</span>
<span class="n">dt</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">string</span><span class="p">,</span> <span class="s">'%a %b </span><span class="si">%d</span><span class="s"> %H:%M:%S %z %Y'</span><span class="p">)</span>
</code></pre></div>
<p>Now, we need the current time. There are two functions to get the current time: <code>now</code> or <code>utcnow</code>. The problem with <code>now</code> is that it returns the current local time. So we would need to figure out what is the local timezone, which isn't straightforward (more on that later). <code>utcnow</code> returns the UTC time, so we know the timezone by definition. Note that even if we know the timezone, <code>utcnow</code> still returns a <em>naive</em> object, so we'll have to manually set the timezone to UTC:</p>
<div class="codehilite"><pre class="source"><code><span class="n">now</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">now</span> <span class="o">=</span> <span class="n">now</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span> <span class="c"># Getting an aware datetime object</span>
</code></pre></div>
<p>We can now subtract the two datetime objects to obtain a timedelta object, which has the fancy <code>seconds</code> attribute:</p>
<div class="codehilite"><pre class="source"><code><span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">dt</span>
<span class="k">print</span><span class="p">(</span><span class="n">delta</span><span class="o">.</span><span class="n">seconds</span><span class="p">)</span> <span class="c"># Prints the timespan in seconds between dt and now</span>
</code></pre></div>
<h2>Getting the local timezone</h2>
<p>In the last part, another strategy would have been to use the <code>now</code> to obtain the local time and then set the local timezone to the datetime object obtained. But getting the local timezone isn't easy. I haven't found any function in the documentation doing that, and posts on the subject on StackOverflow advice using the <code>tzlocal</code> module, which isn't present in the standard library.</p>
<p>It's still possible with the vanilla datetime module.</p>
<p>First, a solution that would work sometimes:</p>
<div class="codehilite"><pre class="source"><code><span class="n">diff</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span><span class="p">()</span>
<span class="n">minutes</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">diff</span><span class="o">.</span><span class="n">seconds</span> <span class="o">/</span> <span class="mi">60</span><span class="p">)</span>
<span class="n">local_timezone</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="n">timedelta</span><span class="p">(</span><span class="n">minutes</span><span class="o">=</span><span class="n">minutes</span><span class="p">))</span>
</code></pre></div>
<p>Here we get the timezone as the difference between <code>now</code> and <code>utcnow</code>. But since the two functions are not executed at the exact same time, the difference doesn't produce a timedelta object with a whole number of minutes, which is the condition for a timedelta to be used to construct a timezone. We get a whole number of minutes by rounding the number of seconds divided by 60. Then we construct a timezone thanks to a new timedelta.</p>
<p>Now imagine that this code runs on a <em>very</em> slow computer and more than a minute is gone between the execution of the two functions, and you've got a corrupted timezone. So, it doesn't really work.</p>
<p>To make it work we can use a timestamp. Python can parse POSIX timestamp into datetime objects. We can use <code>fromtimestamp</code> to get the local datetime from a timestamp and <code>utcfromtimestamp</code> to get the UTC datetime from the same timestamp, then substract the two, which, this time, will represent the exact same instant:</p>
<div class="codehilite"><pre class="source"><code><span class="n">TIMESTAMP</span> <span class="o">=</span> <span class="mi">42</span>
<span class="n">dt_utc</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">utcfromtimestamp</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">)</span>
<span class="n">dt_local</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">fromtimestamp</span><span class="p">(</span><span class="n">TIMESTAMP</span><span class="p">)</span>
<span class="n">diff</span> <span class="o">=</span> <span class="n">dt_local</span> <span class="o">-</span> <span class="n">dt_utc</span>
<span class="n">local_timezone</span> <span class="o">=</span> <span class="n">timezone</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>
</code></pre></div>
<p>Well, to be perfectly honnest, I'm still not absolutely convinced that this would work 100% of the time. Depending on the implementation of the <code>fromtimestamps</code> methods, there may exist edge cases causing trouble some times. I don't know. At the end of the day, the true way to get the timezone is to look at the operating system's specific configuration file containing such information, which is set by the user when it installs the operating system. This is what the <code>tzlocal</code> module does by the way. Python probably does it too when it does anything UTC.</p>
	
</article>

<div id="front_nav">
	<a href="/reddit-np">Next</a>
	-
	<a href="/firestory">Previous</a>
</div>



			</div>
			
			<aside>
				<section>
					<h1>Last articles</h1>

					<ul>
						
							<li><a href="/foobar2000">The music I listen to</a></li>
						
							<li><a href="/reddit-np">The np problem, Reddit edition</a></li>
						
							<li><a href="/datetime-python">Datetime in Python</a></li>
						
							<li><a href="/firestory">Why Firefox was losing track of my history</a></li>
						
					</ul>
				</section>
				
				<section>
					<h1>Tags</h1>
					
					<ul>
						
							<li><a href="/tag/data">data</a> (2)</li>
						
							<li><a href="/tag/programming">programming</a> (1)</li>
						
							<li><a href="/tag/python">python</a> (2)</li>
						
							<li><a href="/tag/reddit">reddit</a> (1)</li>
						
							<li><a href="/tag/software">software</a> (2)</li>
						
					</ul>
				</section>
			</aside>
		
		</div>
		
		<footer>
			This blog and its articles are licensed under the <a href="https://creativecommons.org/licenses/by-nc/4.0/">Creative Commons Attribution-NonCommercial 4.0 International</a> license. This basically means that you can copy, share and remix the articles, provided that you give appropriate credit, indicate if changes were made, and that it is not for commercial use.
		</footer>
	
	</div>
	</body>

</html>